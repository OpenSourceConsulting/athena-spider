/*
 * File: app/controller/UserController.js
 *
 * This file was generated by Sencha Architect version 3.0.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('spider.controller.UserController', {
    extend: 'Ext.app.Controller',

    init: function(application) {
        var user = this;

        //VM Host Tree Constants
        Ext.define('userConstants', {
            singleton: true,
            me : user

        });
    },

    popAddUserWindow: function() {
        //User 등록 팝업 호출
        var popWindow = Ext.create("widget.AddUserWindow");
        popWindow.setTitle("User 등록");

        popWindow.show();

    },

    popEditUserWindow: function(record) {
        //User 등록 팝업 호출
        var popWindow = Ext.create("widget.AddUserWindow");
        popWindow.setTitle("User 수정");

        popWindow.show();

        var addUserForm = Ext.getCmp("addUserForm");
        addUserForm.getForm().loadRecord(record);

        addUserForm.getForm().findField("userId").setReadOnly(true);
        addUserForm.getForm().findField("confirmpw").setValue(record.get("password"));
    },

    saveUser: function(button) {
        var addUserForm = Ext.getCmp("addUserForm");

        var formUrl = GLOBAL.apiUrlPrefix + "user/insert";
        var formMethod = "POST";
        if(addUserForm.up('window').title == "User 수정") {
            formUrl = GLOBAL.apiUrlPrefix + "user/update";
            formMethod = "PUT";
        }

        if(addUserForm.isValid()) {

            var sendData = addUserForm.getForm().getFieldValues();

             Ext.Ajax.request({
                 url: formUrl,
                 method: formMethod,
                 headers : {
                     "Content-Type" : "application/json"
                 },
                 waitMsg: 'Saving Data...',
                 waitMsgTarget : addUserForm.getEl(),
                 jsonData: sendData,
                 success: function (response) {

                     if(response.status == 200) {

                         Ext.Msg.alert('Success', '저장이 완료되었습니다.');

                         Ext.getStore("UserStore").reload();

                         addUserForm.up('window').close();

                     }

                },
                failure: function (response) {
                    Ext.Msg.alert('Failure', response.responseText.replace(/(?:\r\n|\r|\n)/g, '<br />'));
                }
             });

        }

    },

    deleteUser: function(record) {

        Ext.MessageBox.confirm('Confirm', '해당 User 정보를 삭제하시겠습니까?', function(btn){

            if(btn == "yes"){

                Ext.Ajax.request({
                    url: GLOBAL.apiUrlPrefix + "user/delete",
                    method: "DELETE",
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    waitMsg: 'Delete Data...',
                    waitMsgTarget : Ext.getCmp("UserManagementPanel").getEl(),
                    jsonData: {userId : record.get("userId")},
                    success: function (response) {

                        if(response.status == 200) {

                            Ext.Msg.alert('Success', '삭제가 완료되었습니다.', function (){

                                Ext.getStore("UserStore").reload();

                            });

                        }

                    },
                    failure: function (response) {
                        Ext.Msg.alert('Failure', response.responseText.replace(/(?:\r\n|\r|\n)/g, '<br />'));
                    }
                });

            }


        });
    }

});
